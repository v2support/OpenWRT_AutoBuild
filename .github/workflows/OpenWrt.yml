name: Build OpenWrt for Xiaomi AX3000T

on:
  workflow_dispatch: # å…è®¸åœ¨GitHubç½‘é¡µç•Œé¢æ‰‹åŠ¨è§¦å‘å·¥ä½œæµ
  repository_dispatch: # å…è®¸é€šè¿‡APIäº‹ä»¶è§¦å‘
  push: # å½“æœ‰ä»£ç æ¨é€æ—¶è§¦å‘
    paths:
      - '.github/workflows/**' # å½“workflowsç›®å½•ä¸‹çš„æ–‡ä»¶æœ‰å˜åŒ–æ—¶
      - 'config/**' # å½“configç›®å½•ä¸‹çš„æ–‡ä»¶æœ‰å˜åŒ–æ—¶
      - 'scripts/**' # å½“scriptsç›®å½•ä¸‹çš„æ–‡ä»¶æœ‰å˜åŒ–æ—¶
    branches: [ main, master ] # åªåœ¨ä¸»åˆ†æ”¯è§¦å‘

env:
  REPO_URL: https://github.com/openwrt/openwrt
  REPO_BRANCH: openwrt-24.10
  CONFIG_FILE: config/xiaomi-ax3000t.config
  DIY_P1_SH: scripts/diy-part1.sh
  DIY_P2_SH: scripts/diy-part2.sh
  UPLOAD_BIN_DIR: false
  UPLOAD_FIRMWARE: true
  UPLOAD_RELEASE: true
  TZ: Asia/Shanghai

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: æ¸…ç†ç¯å¢ƒ
      run: |
        sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc
        sudo apt-get autoremove -y
        sudo apt-get autoclean
        df -h

    - name: å®‰è£…ç¼–è¯‘ç¯å¢ƒ
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential ccache ecj fastjar file g++ gawk \
        gettext git java-propose-classpath libelf-dev libncurses5-dev \
        libncursesw5-dev libssl-dev python3 python3-setuptools python3-pip \
        python3-dev unzip wget rsync subversion swig time \
        xsltproc zlib1g-dev clang

    - name: ä¸‹è½½OpenWrtæºç 
      run: |
        echo "ä¸‹è½½OpenWrt 24.10ç‰ˆæœ¬..."
        git clone $REPO_URL -b $REPO_BRANCH --depth=1
        cd openwrt
        echo "æºç ä¸‹è½½å®Œæˆ"

    - name: æ‰§è¡Œè‡ªå®šä¹‰è„šæœ¬ç¬¬ä¸€éƒ¨åˆ†
      run: |
        cd openwrt
        if [ -f "../$DIY_P1_SH" ]; then
          echo "æ‰§è¡Œè‡ªå®šä¹‰è„šæœ¬: ../$DIY_P1_SH"
          chmod +x "../$DIY_P1_SH"
          "../$DIY_P1_SH"
        else
          echo "æœªæ‰¾åˆ°è‡ªå®šä¹‰è„šæœ¬: ../$DIY_P1_SH"
        fi

    - name: æ›´æ–°feeds - åªä½¿ç”¨å®˜æ–¹æº
      run: |
        cd openwrt
        ./scripts/feeds update -a
        ./scripts/feeds install -a
        echo "å®˜æ–¹feedså®‰è£…å®Œæˆ"

    - name: ç”Ÿæˆè®¾å¤‡é…ç½®
      run: |
        cd openwrt
        echo "é…ç½®å°ç±³AX3000T..."
        
        if [ -f "../$CONFIG_FILE" ]; then
          echo "ä½¿ç”¨å¤–éƒ¨é…ç½®æ–‡ä»¶: ../$CONFIG_FILE"
          cp "../$CONFIG_FILE" .config
        else
          echo "æœªæ‰¾åˆ°å¤–éƒ¨é…ç½®æ–‡ä»¶ï¼Œä½¿ç”¨é»˜è®¤é…ç½®"
          # ä½¿ç”¨ç®€å•çš„é…ç½®ï¼Œé¿å…EOFé—®é¢˜
          echo "CONFIG_TARGET_mediatek=y" > .config
          echo "CONFIG_TARGET_mediatek_filogic=y" >> .config
          echo "CONFIG_TARGET_mediatek_filogic_DEVICE_xiaomi_mi-router-ax3000t=y" >> .config
        fi
        
        echo "é…ç½®æ–‡ä»¶ç”Ÿæˆå®Œæˆ"
        make defconfig

    - name: æ‰§è¡Œè‡ªå®šä¹‰è„šæœ¬ç¬¬äºŒéƒ¨åˆ†
      run: |
        cd openwrt
        if [ -f "../$DIY_P2_SH" ]; then
          echo "æ‰§è¡Œè‡ªå®šä¹‰è„šæœ¬: ../$DIY_P2_SH"
          chmod +x "../$DIY_P2_SH"
          "../$DIY_P2_SH"
        else
          echo "æœªæ‰¾åˆ°è‡ªå®šä¹‰è„šæœ¬: ../$DIY_P2_SH"
        fi

    - name: ä¸‹è½½æºç åŒ…
      run: |
        cd openwrt
        echo "ä¸‹è½½ç¼–è¯‘ä¾èµ–åŒ…..."
        make download -j4
        find dl -size -1024c -exec rm -f {} \; 2>/dev/null || true
        echo "ä¾èµ–åŒ…ä¸‹è½½å®Œæˆ"

    - name: ç¼–è¯‘å›ºä»¶
      run: |
        cd openwrt
        echo "========================================="
        echo "å¼€å§‹ç¼–è¯‘ OpenWrt 24.10 for å°ç±³AX3000T"
        echo "ç¼–è¯‘å¼€å§‹æ—¶é—´: $(date)"
        echo "========================================="
        
        export FORCE_UNSAFE_CONFIGURE=1
        COMPILE_THREADS=4
        
        echo "ä½¿ç”¨ ${COMPILE_THREADS} çº¿ç¨‹ç¼–è¯‘"
        free -h
        echo "========================================="
        
        make -j${COMPILE_THREADS} V=s
        
        echo "========================================="
        echo "ç¼–è¯‘ç»“æŸæ—¶é—´: $(date)"
        echo "========================================="
        
        if [ -d "bin/targets/mediatek/filogic" ]; then
          echo "âœ… ç¼–è¯‘æˆåŠŸï¼"
          ls -la bin/targets/mediatek/filogic/
          echo "COMPILE_SUCCESS=true" >> $GITHUB_ENV
          echo "FIRMWARE_PATH=$(pwd)/bin/targets/mediatek/filogic" >> $GITHUB_ENV
        else
          echo "âŒ ç¼–è¯‘å¤±è´¥"
          find bin/targets -type d 2>/dev/null || echo "æœªæ‰¾åˆ°targetsç›®å½•"
          exit 1
        fi

    - name: æ•´ç†å›ºä»¶æ–‡ä»¶
      if: env.COMPILE_SUCCESS == 'true'
      run: |
        cd ${{ env.FIRMWARE_PATH }}
        echo "æ•´ç†å›ºä»¶æ–‡ä»¶..."
        
        rm -rf packages
        find . -name "*.md5sum" -delete
        find . -name "*.sha256sum" -delete
        find . -name "*.md5" -delete
        find . -name "*.sha256" -delete
        
        echo "æœ€ç»ˆå›ºä»¶æ–‡ä»¶ï¼š"
        ls -lh *.bin 2>/dev/null || echo "æœªæ‰¾åˆ°binæ–‡ä»¶"

    - name: è·å–å½“å‰æ—¥æœŸ
      id: build_date
      run: echo "date=$(date +'%Y%m%d')" >> $GITHUB_OUTPUT

    - name: è·å–ç³»ç»Ÿä¿¡æ¯
      id: system_info
      run: |
        OS_INFO=$(cat /etc/os-release | grep PRETTY_NAME | cut -d '"' -f2)
        echo "os_info=${OS_INFO}" >> $GITHUB_OUTPUT

    - name: åˆ›å»ºRelease
      if: env.COMPILE_SUCCESS == 'true'
      uses: softprops/action-gh-release@v2
      with:
        tag_name: "openwrt-24.10-${{ github.run_number }}-${{ steps.build_date.outputs.date }}"
        name: "å°ç±³AX3000T OpenWrt 24.10 - Build ${{ github.run_number }}"
        body: |
          ğŸ‰ **å°ç±³AX3000T OpenWrt 24.10 å›ºä»¶**
          
          ğŸ“¦ **å›ºä»¶ä¿¡æ¯**:
          - ğŸ”§ åŸºäº: OpenWrt 24.10 å®˜æ–¹ç‰ˆæœ¬
          - ğŸ“… ç¼–è¯‘æ—¶é—´: ${{ steps.date.outputs.date }}
          - ğŸ”¢ æ„å»ºç¼–å·: #${{ github.run_number }}
          - ğŸ  é»˜è®¤åœ°å€: http://10.0.0.1
          - ğŸ‘¤ é»˜è®¤è´¦æˆ·: root (å¯†ç ä¸ºç©º)
          
          âœ… **åŒ…å«åŠŸèƒ½**:
          - ğŸ“¡ å®Œæ•´è·¯ç”±å™¨åŠŸèƒ½
          - ğŸ“¶ Wi-Fi 6 åŒé¢‘æ”¯æŒ
          - ğŸŒ LuCI Webç®¡ç†ç•Œé¢
          - ğŸ”’ IPSec VPNæœåŠ¡å™¨
          
          ğŸ“‹ **ä½¿ç”¨è¯´æ˜**:
          1. ç¡®è®¤è®¾å¤‡å‹å·ä¸ºå°ç±³AX3000T v1
          2. åˆ·æœºå‰åŠ¡å¿…å¤‡ä»½åŸå‚å›ºä»¶
          3. åˆ·å…¥å›ºä»¶åè®¿é—® http://10.0.0.1
          4. ç”¨æˆ·å: rootï¼Œå¯†ç ä¸ºç©º
          
          âš ï¸ **é‡è¦æé†’**:
          - é€‚ç”¨äºå°ç±³AX3000T v1 (MT7981èŠ¯ç‰‡)
          - åˆ·æœºæœ‰é£é™©ï¼Œè¯·ç¡®ä¿äº†è§£åˆ·æœºæµç¨‹
        files: |
          ${{ env.FIRMWARE_PATH }}/*
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: è·å–å½“å‰æ—¶é—´
      id: date
      run: echo "date=$(date +'%Yå¹´%mæœˆ%dæ—¥ %H:%M')" >> $GITHUB_OUTPUT

    - name: ç¼–è¯‘æ€»ç»“
      if: always()
      run: |
        echo "========================================="
        echo "           ç¼–è¯‘æ€»ç»“æŠ¥å‘Š"
        echo "========================================="
        echo "çŠ¶æ€: ${{ env.COMPILE_SUCCESS == 'true' && 'âœ… æˆåŠŸ' || 'âŒ å¤±è´¥' }}"
        echo "æ—¶é—´: $(date +'%Y-%m-%d %H:%M:%S')"
        echo "ç‰ˆæœ¬: OpenWrt 24.10"
        echo "è®¾å¤‡: å°ç±³AX3000T v1"
        echo "æ„å»º: #${{ github.run_number }}"
        if [ "${{ env.COMPILE_SUCCESS }}" == "true" ]; then
          echo "å›ºä»¶: ${{ env.FIRMWARE_PATH }}"
          echo "ğŸ‰ æ­å–œï¼å›ºä»¶ç¼–è¯‘æˆåŠŸ"
          echo "ğŸ“¥ ä¸‹è½½åœ°å€: ${{ github.server_url }}/${{ github.repository }}/releases/latest"
        else
          echo "ğŸ˜ ç¼–è¯‘å¤±è´¥ï¼Œè¯·æ£€æŸ¥é”™è¯¯ä¿¡æ¯"
        fi
        echo "========================================="

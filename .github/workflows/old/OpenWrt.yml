name: Build OpenWrt for Xiaomi AX3000T

on:
  workflow_dispatch: # å…è®¸åœ¨GitHubç½‘é¡µç•Œé¢æ‰‹åŠ¨è§¦å‘å·¥ä½œæµ
  repository_dispatch: # å…è®¸é€šè¿‡APIäº‹ä»¶è§¦å‘

env:
  REPO_URL: https://github.com/openwrt/openwrt
  REPO_BRANCH: openwrt-24.10
  DIY_P1_SH: diy-part1.sh
  DIY_P2_SH: diy-part2.sh
  UPLOAD_BIN_DIR: false
  UPLOAD_FIRMWARE: true
  UPLOAD_RELEASE: true
  TZ: Asia/Shanghai

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: æ¸…ç†ç¯å¢ƒ
      run: |
        sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc
        sudo apt-get autoremove -y
        sudo apt-get autoclean
        df -h

    - name: å®‰è£…ç¼–è¯‘ç¯å¢ƒ
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential ccache ecj fastjar file g++ gawk \
        gettext git java-propose-classpath libelf-dev libncurses5-dev \
        libncursesw5-dev libssl-dev python3 python3-setuptools python3-pip \
        python3-dev unzip wget rsync subversion swig time \
        xsltproc zlib1g-dev clang

    - name: ä¸‹è½½OpenWrtæºç 
      run: |
        echo "ä¸‹è½½OpenWrt 24.10ç‰ˆæœ¬..."
        git clone $REPO_URL -b $REPO_BRANCH --depth=1
        cd openwrt
        echo "æºç ä¸‹è½½å®Œæˆ"

    - name: æ›´æ–°feeds - åªä½¿ç”¨å®˜æ–¹æº
      run: |
        cd openwrt
        ./scripts/feeds update -a
        ./scripts/feeds install -a
        echo "å®˜æ–¹feedså®‰è£…å®Œæˆ"

    - name: ç”Ÿæˆè®¾å¤‡é…ç½®
      run: |
        cd openwrt
        echo "é…ç½®å°ç±³AX3000T..."
        cat > .config << 'EOF'
        # æ­£ç¡®é…ç½®ï¼šå°ç±³AX3000Tå±äºmediatek/filogicå¹³å°
        CONFIG_TARGET_mediatek=y
        CONFIG_TARGET_mediatek_filogic=y
        CONFIG_TARGET_mediatek_filogic_DEVICE_xiaomi_mi-router-ax3000t=y
        
        # æ ¸å¿ƒç³»ç»ŸåŒ…
        CONFIG_PACKAGE_base-files=y
        CONFIG_PACKAGE_busybox=y
        CONFIG_PACKAGE_ca-bundle=y
        CONFIG_PACKAGE_ca-certificates=y
        CONFIG_PACKAGE_dropbear=y
        CONFIG_PACKAGE_dnsmasq-full=y
        CONFIG_PACKAGE_firewall4=y
        CONFIG_PACKAGE_nftables=y
        CONFIG_PACKAGE_ppp=y
        CONFIG_PACKAGE_ppp-mod-pppoe=y
        CONFIG_PACKAGE_procd=y
        CONFIG_PACKAGE_procd-ujail=y
        CONFIG_PACKAGE_opkg=y
        CONFIG_PACKAGE_uci=y
        CONFIG_PACKAGE_urandom-seed=y
        CONFIG_PACKAGE_urngd=y
        
        # ç½‘ç»œåŸºç¡€åŒ…
        CONFIG_PACKAGE_ip-full=y
        CONFIG_PACKAGE_ipset=y
        CONFIG_PACKAGE_iptables=y
        CONFIG_PACKAGE_iptables-mod-conntrack-extra=y
        CONFIG_PACKAGE_iptables-mod-ipopt=y
        CONFIG_PACKAGE_kmod-ipt-core=y
        CONFIG_PACKAGE_kmod-ipt-nat=y
        CONFIG_PACKAGE_kmod-nf-conntrack=y
        CONFIG_PACKAGE_kmod-nf-nat=y
        
        # æ— çº¿æ”¯æŒ
        CONFIG_PACKAGE_hostapd-common=y
        CONFIG_PACKAGE_wpad-wolfssl=y
        CONFIG_PACKAGE_kmod-cfg80211=y
        CONFIG_PACKAGE_kmod-mac80211=y
        CONFIG_PACKAGE_wireless-tools=y
        
        # VPNæ”¯æŒ
        CONFIG_PACKAGE_strongswan-minimal=y
        CONFIG_PACKAGE_strongswan-charon=y
        CONFIG_PACKAGE_strongswan-mod-aes=y
        CONFIG_PACKAGE_strongswan-mod-kernel-netlink=y
        CONFIG_PACKAGE_strongswan-mod-socket-default=y
        CONFIG_PACKAGE_kmod-ipsec=y
        CONFIG_PACKAGE_kmod-ipsec4=y
        CONFIG_PACKAGE_kmod-crypto-aead=y
        CONFIG_PACKAGE_kmod-crypto-authenc=y
        
        # LuCI Webç•Œé¢
        CONFIG_PACKAGE_luci=y
        CONFIG_PACKAGE_luci-base=y
        CONFIG_PACKAGE_luci-mod-admin-full=y
        CONFIG_PACKAGE_luci-mod-network=y
        CONFIG_PACKAGE_luci-mod-status=y
        CONFIG_PACKAGE_luci-mod-system=y
        CONFIG_PACKAGE_luci-theme-bootstrap=y
        CONFIG_PACKAGE_luci-app-firewall=y
        CONFIG_PACKAGE_luci-app-opkg=y
        CONFIG_PACKAGE_luci-lib-base=y
        CONFIG_PACKAGE_luci-lib-ip=y
        CONFIG_PACKAGE_luci-lib-jsonc=y
        CONFIG_PACKAGE_luci-lib-nixio=y
        
        # åŸºç¡€å·¥å…·
        CONFIG_PACKAGE_curl=y
        CONFIG_PACKAGE_wget-ssl=y
        CONFIG_PACKAGE_nano=y
        
        # ç§»é™¤å¯èƒ½å†²çªçš„åŒ…
        # CONFIG_PACKAGE_dnsmasq is not set
        CONFIG_PACKAGE_wpad-basic-wolfssl=n
        
        # ç¼–è¯‘å™¨ä¼˜åŒ–
        CONFIG_TARGET_OPTIMIZATION="-Os -pipe"
        CONFIG_SOFT_FLOAT=n
        EOF
        
        echo "é…ç½®æ–‡ä»¶ç”Ÿæˆå®Œæˆ"
        make defconfig

    - name: æ‰§è¡Œè‡ªå®šä¹‰è„šæœ¬ç¬¬ä¸€éƒ¨åˆ†
      run: |
        cd openwrt
        if [ -f "../$DIY_P1_SH" ]; then
          echo "æ‰§è¡Œè‡ªå®šä¹‰è„šæœ¬: ../$DIY_P1_SH"
          chmod +x "../$DIY_P1_SH"
          "../$DIY_P1_SH"
        else
          echo "æœªæ‰¾åˆ°è‡ªå®šä¹‰è„šæœ¬: ../$DIY_P1_SH"
        fi

    - name: æ‰§è¡Œè‡ªå®šä¹‰è„šæœ¬ç¬¬äºŒéƒ¨åˆ†
      run: |
        cd openwrt
        if [ -f "../$DIY_P2_SH" ]; then
          echo "æ‰§è¡Œè‡ªå®šä¹‰è„šæœ¬: ../$DIY_P2_SH"
          chmod +x "../$DIY_P2_SH"
          "../$DIY_P2_SH"
        else
          echo "æœªæ‰¾åˆ°è‡ªå®šä¹‰è„šæœ¬: ../$DIY_P2_SH"
        fi

    - name: ä¸‹è½½æºç åŒ…
      run: |
        cd openwrt
        echo "ä¸‹è½½ç¼–è¯‘ä¾èµ–åŒ…..."
        # ä½¿ç”¨4çº¿ç¨‹ä¸‹è½½
        echo "ä½¿ç”¨ 4 çº¿ç¨‹ä¸‹è½½ä¾èµ–åŒ…"
        make download -j4
        find dl -size -1024c -exec rm -f {} \; 2>/dev/null || true
        echo "ä¾èµ–åŒ…ä¸‹è½½å®Œæˆ"

    - name: ç¼–è¯‘å›ºä»¶
      run: |
        cd openwrt
        echo "========================================="
        echo "å¼€å§‹ç¼–è¯‘ OpenWrt 24.10 for å°ç±³AX3000T"
        echo "ç¼–è¯‘å¼€å§‹æ—¶é—´: $(date)"
        echo "========================================="
        
        # è®¾ç½®ç¼–è¯‘ç¯å¢ƒå˜é‡
        export FORCE_UNSAFE_CONFIGURE=1
        
        # è·å–CPUæ ¸å¿ƒæ•°
        AVAILABLE_CORES=$(nproc)
        echo "æ£€æµ‹åˆ°CPUæ ¸å¿ƒæ•°: ${AVAILABLE_CORES}"
        
        # ä½¿ç”¨4çº¿ç¨‹ç¼–è¯‘ï¼ˆå……åˆ†åˆ©ç”¨GitHub Actionsçš„4æ ¸å¿ƒï¼‰
        COMPILE_THREADS=4
        
        echo "ä½¿ç”¨ ${COMPILE_THREADS} çº¿ç¨‹ç¼–è¯‘"
        echo "å¯ç”¨å†…å­˜æƒ…å†µ:"
        free -h
        echo "========================================="
        
        # ç¼–è¯‘å›ºä»¶ - ä½¿ç”¨4çº¿ç¨‹
        make -j${COMPILE_THREADS} V=s
        
        echo "========================================="
        echo "ç¼–è¯‘ç»“æŸæ—¶é—´: $(date)"
        echo "========================================="
        
        # æ£€æŸ¥ç¼–è¯‘ç»“æœ - æ­£ç¡®çš„filogicç›®å½•
        if [ -d "bin/targets/mediatek/filogic" ]; then
          echo "âœ… ç¼–è¯‘æˆåŠŸï¼"
          echo "å›ºä»¶æ–‡ä»¶ï¼š"
          ls -la bin/targets/mediatek/filogic/
          echo "COMPILE_SUCCESS=true" >> $GITHUB_ENV
          echo "FIRMWARE_PATH=$(pwd)/bin/targets/mediatek/filogic" >> $GITHUB_ENV
        else
          echo "âŒ ç¼–è¯‘å¤±è´¥ï¼Œæ£€æŸ¥å¯ç”¨ç›®å½•ï¼š"
          find bin/targets -type d 2>/dev/null || echo "æœªæ‰¾åˆ°targetsç›®å½•"
          exit 1
        fi

    - name: æ•´ç†å›ºä»¶æ–‡ä»¶
      if: env.COMPILE_SUCCESS == 'true'
      run: |
        cd ${{ env.FIRMWARE_PATH }}
        echo "æ•´ç†å›ºä»¶æ–‡ä»¶..."
        
        # åˆ é™¤packagesç›®å½•èŠ‚çœç©ºé—´
        rm -rf packages
        
        # è·å–å½“å‰æ—¥æœŸ
        BUILD_DATE=$(date +%Y%m%d)
        
        # åªä¿ç•™ä¸»å›ºä»¶æ–‡ä»¶ï¼Œè¿‡æ»¤æ‰DDRå’Œbootloaderæ–‡ä»¶
        echo "è¿‡æ»¤æ–‡ä»¶ï¼Œåªä¿ç•™ä¸»å›ºä»¶..."
        
        # æ‰¾åˆ°ä¸»å›ºä»¶æ–‡ä»¶ï¼ˆé€šå¸¸æ˜¯sysupgradeæˆ–factoryæ–‡ä»¶ï¼‰
        MAIN_FIRMWARE=""
        for file in *xiaomi*sysupgrade*.bin; do
          if [ -f "$file" ]; then
            MAIN_FIRMWARE="$file"
            break
          fi
        done
        
        # å¦‚æœæ²¡æ‰¾åˆ°sysupgradeï¼Œå¯»æ‰¾factoryæ–‡ä»¶
        if [ -z "$MAIN_FIRMWARE" ]; then
          for file in *xiaomi*factory*.bin; do
            if [ -f "$file" ]; then
              MAIN_FIRMWARE="$file"
              break
            fi
          done
        fi
        
        # å¦‚æœè¿˜æ˜¯æ²¡æ‰¾åˆ°ï¼Œå¯»æ‰¾ä»»ä½•ä¸åŒ…å«ram/ddr/blçš„xiaomiæ–‡ä»¶
        if [ -z "$MAIN_FIRMWARE" ]; then
          for file in *xiaomi*.bin; do
            if [[ "$file" != *"ram"* ]] && [[ "$file" != *"ddr"* ]] && [[ "$file" != *"-bl"* ]]; then
              MAIN_FIRMWARE="$file"
              break
            fi
          done
        fi
        
        if [ -n "$MAIN_FIRMWARE" ]; then
          echo "æ‰¾åˆ°ä¸»å›ºä»¶: $MAIN_FIRMWARE"
          # é‡å‘½åä¸»å›ºä»¶æ–‡ä»¶
          newname="AX3000T-OpenWrt-24.10-${BUILD_DATE}-${MAIN_FIRMWARE}"
          mv "$MAIN_FIRMWARE" "$newname"
          echo "é‡å‘½å: $MAIN_FIRMWARE -> $newname"
          
          # åˆ é™¤å…¶ä»–æ‰€æœ‰.binæ–‡ä»¶ï¼ˆåŒ…æ‹¬ddrã€ramã€blç­‰ï¼‰
          find . -name "*.bin" ! -name "$newname" -delete
          echo "å·²æ¸…ç†å…¶ä»–å›ºä»¶æ–‡ä»¶"
          
          echo "MAIN_FIRMWARE_NAME=$newname" >> $GITHUB_ENV
        else
          echo "âŒ æœªæ‰¾åˆ°ä¸»å›ºä»¶æ–‡ä»¶"
          exit 1
        fi
        
        echo "========================================="
        echo "æœ€ç»ˆå›ºä»¶æ–‡ä»¶ï¼š"
        ls -lh *.bin 2>/dev/null || echo "æœªæ‰¾åˆ°æ–‡ä»¶"
        echo "========================================="

    - name: è·å–å½“å‰æ—¥æœŸ
      id: build_date
      run: echo "date=$(date +'%Y%m%d')" >> $GITHUB_OUTPUT

    - name: è·å–ç³»ç»Ÿä¿¡æ¯
      id: system_info
      run: |
        OS_INFO=$(cat /etc/os-release | grep PRETTY_NAME | cut -d '"' -f2)
        echo "os_info=${OS_INFO}" >> $GITHUB_OUTPUT

    - name: åˆ›å»ºRelease
      if: env.COMPILE_SUCCESS == 'true'
      uses: softprops/action-gh-release@v2
      with:
        tag_name: "openwrt-24.10-${{ github.run_number }}-${{ steps.build_date.outputs.date }}"
        name: "å°ç±³AX3000T OpenWrt 24.10 - Build ${{ github.run_number }}"
        body: |
          ğŸ‰ **å°ç±³AX3000T OpenWrt 24.10 å›ºä»¶**
          
          ğŸ“¦ **å›ºä»¶ä¿¡æ¯**:
          - ğŸ”§ åŸºäº: OpenWrt 24.10 å®˜æ–¹ç‰ˆæœ¬
          - ğŸ“… ç¼–è¯‘æ—¶é—´: ${{ steps.date.outputs.date }}
          - ğŸ”¢ æ„å»ºç¼–å·: #${{ github.run_number }}
          - ğŸ  é»˜è®¤åœ°å€: http://10.0.0.1
          - ğŸ‘¤ é»˜è®¤è´¦æˆ·: root (å¯†ç ä¸ºç©º)
          - ğŸ–¥ï¸ ç¼–è¯‘ç¯å¢ƒ: ${{ steps.system_info.outputs.os_info }} (4çº¿ç¨‹ç¼–è¯‘)
          
          âœ… **åŒ…å«åŠŸèƒ½**:
          - ğŸ“¡ å®Œæ•´è·¯ç”±å™¨åŠŸèƒ½ (é˜²ç«å¢™ã€NATã€DHCPã€PPPoE)
          - ğŸ“¶ Wi-Fi 6 åŒé¢‘æ”¯æŒ (2.4G + 5G)
          - ğŸŒ LuCI Webç®¡ç†ç•Œé¢
          - ğŸ”’ IPSec VPNæœåŠ¡å™¨ (strongSwan)
          - ğŸ› ï¸ åŸºç¡€ç½‘ç»œå·¥å…· (curl, wget, nanoç­‰)
          
          ğŸ“‹ **ä½¿ç”¨è¯´æ˜**:
          1. ç¡®è®¤è®¾å¤‡å‹å·ä¸ºå°ç±³AX3000T v1
          2. åˆ·æœºå‰åŠ¡å¿…å¤‡ä»½åŸå‚å›ºä»¶
          3. åˆ·å…¥å›ºä»¶åè®¿é—® http://10.0.0.1
          4. ç”¨æˆ·å: rootï¼Œå¯†ç ä¸ºç©º
          5. é¦–æ¬¡ç™»å½•åè¯·ç«‹å³è®¾ç½®ç®¡ç†å‘˜å¯†ç 
          
          âš ï¸ **é‡è¦æé†’**:
          - é€‚ç”¨äºå°ç±³AX3000T v1 (ä½¿ç”¨MT7981èŠ¯ç‰‡)
          - OpenWrt 24.10ä¸ºæœ€æ–°ç‰ˆæœ¬ï¼ŒåŠŸèƒ½æ›´å®Œå–„
          - åˆ·æœºæœ‰é£é™©ï¼Œæ“ä½œå‰è¯·ç¡®ä¿äº†è§£åˆ·æœºæµç¨‹
          
          ğŸ“ **æ–‡ä»¶è¯´æ˜**:
          - `.bin` æ–‡ä»¶: ä¸»å›ºä»¶æ–‡ä»¶
        files: |
          ${{ env.FIRMWARE_PATH }}/*.bin
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: è·å–å½“å‰æ—¶é—´
      id: date
      run: echo "date=$(date +'%Yå¹´%mæœˆ%dæ—¥ %H:%M')" >> $GITHUB_OUTPUT

    - name: ç¼–è¯‘æ€»ç»“
      if: always()
      run: |
        echo "========================================="
        echo "           ç¼–è¯‘æ€»ç»“æŠ¥å‘Š"
        echo "========================================="
        echo "çŠ¶æ€: ${{ env.COMPILE_SUCCESS == 'true' && 'âœ… æˆåŠŸ' || 'âŒ å¤±è´¥' }}"
        echo "æ—¶é—´: $(date +'%Y-%m-%d %H:%M:%S')"
        echo "ç‰ˆæœ¬: OpenWrt 24.10"
        echo "è®¾å¤‡: å°ç±³AX3000T v1"
        echo "æ„å»º: #${{ github.run_number }}"
        echo "ç³»ç»Ÿ: ${{ steps.system_info.outputs.os_info }}"
        echo "ç¼–è¯‘çº¿ç¨‹: 4"
        if [ "${{ env.COMPILE_SUCCESS }}" == "true" ]; then
          echo "å›ºä»¶: ${{ env.FIRMWARE_PATH }}"
          echo "ğŸ‰ æ­å–œï¼å›ºä»¶ç¼–è¯‘æˆåŠŸï¼Œè¯·åœ¨Releaseä¸­ä¸‹è½½ä½¿ç”¨"
          echo "ğŸ“¥ ä¸‹è½½åœ°å€: ${{ github.server_url }}/${{ github.repository }}/releases/latest"
        else
          echo "ğŸ˜ ç¼–è¯‘å¤±è´¥ï¼Œè¯·æ£€æŸ¥ä¸Šé¢çš„é”™è¯¯ä¿¡æ¯"
        fi
        echo "========================================="
